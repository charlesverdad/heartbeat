<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - Living Life Bible Study</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="description" content="Teacher portal for reviewing student quiz submissions">
    <style>
        /* Minimal CSS for teacher portal */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f9fafb;
            color: #374151;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .header {
            background: linear-gradient(135deg, #0f766e, #0369a1);
            color: white;
            padding: 2rem;
            border-radius: 8px 8px 0 0;
        }
        
        .content {
            padding: 2rem;
        }
        
        .button {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .button-primary {
            background-color: #0369a1;
            color: white;
        }
        
        .button-primary:hover {
            background-color: #075985;
        }
        
        .button-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .button-secondary:hover {
            background-color: #4b5563;
        }
        
        .button-danger {
            background-color: #dc2626;
            color: white;
        }
        
        .button-danger:hover {
            background-color: #b91c1c;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input:focus {
            outline: none;
            border-color: #0369a1;
            box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1);
        }
        
        .label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .success {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .submission-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }
        
        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
        }
        
        .student-info {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
        }
        
        .submission-meta {
            font-size: 0.875rem;
            color: #6b7280;
            text-align: right;
        }
        
        .question-review {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 4px solid #0369a1;
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        
        .answer-display {
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            margin: 0.5rem 0;
        }
        
        .points-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }
        
        .points-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .score-summary {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            color: #0369a1;
            text-decoration: none;
            margin-bottom: 1rem;
        }
        
        .back-link:hover {
            color: #075985;
        }
        
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #0369a1;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toggle Switch Styles */
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .slider {
            background-color: #0369a1;
        }
        
        .toggle-switch input:focus + .slider {
            box-shadow: 0 0 1px #0369a1;
        }
        
        .toggle-switch input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen" class="card">
            <div class="header">
                <h1>üë©‚Äçüè´ Teacher Portal</h1>
                <p>Review student bible study submissions and manage grades</p>
            </div>
            <div class="content">
                <div id="login-error" class="error hidden"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="password" class="label">Teacher Password</label>
                        <input type="password" id="password" name="password" class="input" 
                               placeholder="Enter teacher password" required>
                    </div>
                    <button type="submit" class="button button-primary">
                        <span id="login-text">üîë Login</span>
                        <span id="login-spinner" class="spinner hidden" style="margin-left: 0.5rem;"></span>
                    </button>
                </form>
                
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <a href="/" class="back-link">
                        ‚Üê Back to Student Portal
                    </a>
                </div>
            </div>
        </div>

        <!-- Dashboard Screen - Submissions List -->
        <div id="dashboard-screen" class="hidden">
            <div class="card">
                <div class="header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1>üìä Teacher Dashboard</h1>
                            <p>Review and grade student bible study submissions</p>
                        </div>
                        <button id="logout-btn" class="button button-secondary">
                            üö™ Logout
                        </button>
                    </div>
                </div>
                <div class="content">
                    <div id="dashboard-error" class="error hidden"></div>
                    <div id="dashboard-loading" class="loading">
                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Loading submissions...</p>
                    </div>
                    <div id="submissions-container" class="hidden">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="font-size: 1.5rem; font-weight: 600;">Student Submissions</h2>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button id="refresh-btn" class="button button-secondary">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                        
                        <!-- Test Mode Settings -->
                        <div class="card" style="margin-bottom: 2rem; border: 2px solid #dbeafe;">
                            <div style="padding: 1.5rem; background: #f0f9ff; border-radius: 8px 8px 0 0; border-bottom: 1px solid #dbeafe;">
                                <h3 style="font-size: 1.125rem; font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">üîß Final Exam Settings</h3>
                                <p style="font-size: 0.875rem; color: #1e40af;">Control whether students can access the final exam</p>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div id="test-mode-error" class="error hidden"></div>
                                <div id="test-mode-success" class="success hidden"></div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block;">Final Exam Access</label>
                                        <p style="font-size: 0.875rem; color: #6b7280;">When enabled, students can take the final exam. When disabled, only practice modes are available.</p>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                            <input type="checkbox" id="test-mode-toggle" style="opacity: 0; width: 0; height: 0;">
                                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                                        </label>
                                        <span id="test-mode-status" style="font-weight: 600; min-width: 80px;">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submissions Summary Table -->
                        <div id="submissions-table-container">
                            <table id="submissions-table" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <thead style="background-color: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Student</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Score</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Questions</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Status</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Submitted</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="submissions-table-body">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="no-submissions" class="hidden" style="text-align: center; padding: 3rem; color: #6b7280;">
                            <p style="font-size: 1.25rem; margin-bottom: 0.5rem;">üìù</p>
                            <p>No test submissions found</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Students will see their submissions here after completing tests</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grading Screen - Individual Submission Detail -->
        <div id="grading-screen" class="hidden">
            <div class="card">
                <div class="header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 id="grading-title">üìù Grading Submission</h1>
                            <p id="grading-subtitle">Review and adjust scores for this submission</p>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button id="back-to-dashboard-btn" class="button button-secondary">
                                ‚Üê Back to List
                            </button>
                            <button id="save-grades-btn" class="button button-primary">
                                üíæ Save All Changes
                            </button>
                        </div>
                    </div>
                </div>
                <div class="content">
                    <div id="grading-error" class="error hidden"></div>
                    <div id="grading-success" class="success hidden"></div>
                    <div id="submission-details">
                        <!-- Individual submission details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Teacher Portal JavaScript
        class TeacherPortal {
            constructor() {
                this.isAuthenticated = false
                this.submissions = []
                this.currentSubmission = null
                this.pendingChanges = new Map() // Track unsaved changes
                this.initializeElements()
                this.bindEvents()
                this.checkSession()
            }
            
            initializeElements() {
                this.screens = {
                    login: document.getElementById('login-screen'),
                    dashboard: document.getElementById('dashboard-screen'),
                    grading: document.getElementById('grading-screen')
                }
                
                this.elements = {
                    // Login screen
                    loginForm: document.getElementById('login-form'),
                    loginError: document.getElementById('login-error'),
                    loginText: document.getElementById('login-text'),
                    loginSpinner: document.getElementById('login-spinner'),
                    
                    // Dashboard screen
                    logoutBtn: document.getElementById('logout-btn'),
                    dashboardError: document.getElementById('dashboard-error'),
                    dashboardLoading: document.getElementById('dashboard-loading'),
                    submissionsContainer: document.getElementById('submissions-container'),
                    submissionsTableBody: document.getElementById('submissions-table-body'),
                    noSubmissions: document.getElementById('no-submissions'),
                    refreshBtn: document.getElementById('refresh-btn'),
                    
                    // Test mode settings
                    testModeToggle: document.getElementById('test-mode-toggle'),
                    testModeStatus: document.getElementById('test-mode-status'),
                    testModeError: document.getElementById('test-mode-error'),
                    testModeSuccess: document.getElementById('test-mode-success'),
                    
                    // Grading screen
                    gradingTitle: document.getElementById('grading-title'),
                    gradingSubtitle: document.getElementById('grading-subtitle'),
                    backToDashboardBtn: document.getElementById('back-to-dashboard-btn'),
                    saveGradesBtn: document.getElementById('save-grades-btn'),
                    gradingError: document.getElementById('grading-error'),
                    gradingSuccess: document.getElementById('grading-success'),
                    submissionDetails: document.getElementById('submission-details')
                }
            }
            
            bindEvents() {
                this.elements.loginForm.addEventListener('submit', this.handleLogin.bind(this))
                this.elements.logoutBtn.addEventListener('click', this.handleLogout.bind(this))
                this.elements.refreshBtn.addEventListener('click', this.loadSubmissions.bind(this))
                this.elements.backToDashboardBtn.addEventListener('click', this.handleBackToDashboard.bind(this))
                this.elements.saveGradesBtn.addEventListener('click', this.handleSaveGrades.bind(this))
                this.elements.testModeToggle.addEventListener('change', this.handleTestModeToggle.bind(this))
            }
            
            showScreen(screenName) {
                Object.values(this.screens).forEach(screen => {
                    screen.classList.add('hidden')
                })
                this.screens[screenName].classList.remove('hidden')
            }
            
            showError(containerId, message) {
                const errorElement = document.getElementById(containerId)
                errorElement.textContent = message
                errorElement.classList.remove('hidden')
            }
            
            hideError(containerId) {
                const errorElement = document.getElementById(containerId)
                errorElement.classList.add('hidden')
            }
            
            async checkSession() {
                try {
                    const response = await fetch('/api/teacher/check-session')
                    if (response.ok) {
                        this.isAuthenticated = true
                        this.showScreen('dashboard')
                        this.loadSubmissions()
                    } else {
                        this.showScreen('login')
                    }
                } catch (error) {
                    console.error('Failed to check session:', error)
                    this.showScreen('login')
                }
            }
            
            async handleLogin(e) {
                e.preventDefault()
                this.hideError('login-error')
                
                const formData = new FormData(e.target)
                const password = formData.get('password')
                
                // Show loading state
                this.elements.loginText.classList.add('hidden')
                this.elements.loginSpinner.classList.remove('hidden')
                
                try {
                    const response = await fetch('/api/teacher/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password })
                    })
                    
                    if (response.ok) {
                        this.isAuthenticated = true
                        this.showScreen('dashboard')
                        this.loadSubmissions()
                    } else {
                        const error = await response.json()
                        this.showError('login-error', error.message || 'Invalid password')
                    }
                } catch (error) {
                    console.error('Login failed:', error)
                    this.showError('login-error', 'Failed to connect to server')
                } finally {
                    // Reset button state
                    this.elements.loginText.classList.remove('hidden')
                    this.elements.loginSpinner.classList.add('hidden')
                }
            }
            
            async handleLogout() {
                try {
                    await fetch('/api/teacher/logout', { method: 'POST' })
                } catch (error) {
                    console.error('Logout error:', error)
                }
                
                this.isAuthenticated = false
                this.showScreen('login')
                this.elements.loginForm.reset()
            }
            
            async loadSubmissions() {
                this.hideError('dashboard-error')
                this.elements.dashboardLoading.classList.remove('hidden')
                this.elements.submissionsContainer.classList.add('hidden')
                
                try {
                    const response = await fetch('/api/teacher/submissions')
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch submissions: ${response.statusText}`)
                    }
                    
                    const data = await response.json()
                    this.submissions = data.submissions || []
                    this.renderSubmissionsTable()
                    
                    // Load test mode status when submissions are loaded
                    this.loadTestModeStatus()
                    
                } catch (error) {
                    console.error('Failed to load submissions:', error)
                    this.showError('dashboard-error', error.message)
                } finally {
                    this.elements.dashboardLoading.classList.add('hidden')
                    this.elements.submissionsContainer.classList.remove('hidden')
                }
            }
            
            async loadTestModeStatus() {
                try {
                    const response = await fetch('/api/settings/test-mode-enabled')
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch test mode status: ${response.statusText}`)
                    }
                    
                    const data = await response.json()
                    const isEnabled = data.enabled
                    
                    // Update toggle state
                    this.elements.testModeToggle.checked = isEnabled
                    
                    // Update status text
                    this.elements.testModeStatus.textContent = isEnabled ? 'Enabled' : 'Disabled'
                    this.elements.testModeStatus.style.color = isEnabled ? '#166534' : '#dc2626'
                    
                } catch (error) {
                    console.error('Failed to load test mode status:', error)
                    this.elements.testModeStatus.textContent = 'Error'
                    this.elements.testModeStatus.style.color = '#dc2626'
                }
            }
            
            async handleTestModeToggle(e) {
                const isEnabled = e.target.checked
                
                this.hideError('test-mode-error')
                this.hideError('test-mode-success')
                
                // Disable toggle temporarily to prevent rapid clicking
                this.elements.testModeToggle.disabled = true
                this.elements.testModeStatus.textContent = 'Updating...'
                this.elements.testModeStatus.style.color = '#6b7280'
                
                try {
                    const response = await fetch('/api/teacher/settings/test-mode', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enabled: isEnabled })
                    })
                    
                    if (!response.ok) {
                        throw new Error(`Failed to update test mode: ${response.statusText}`)
                    }
                    
                    // Update status display
                    this.elements.testModeStatus.textContent = isEnabled ? 'Enabled' : 'Disabled'
                    this.elements.testModeStatus.style.color = isEnabled ? '#166534' : '#dc2626'
                    
                    // Show success message
                    const action = isEnabled ? 'enabled' : 'disabled'
                    this.showError('test-mode-success', `Final exam has been ${action} successfully. Students ${isEnabled ? 'can now' : 'can no longer'} access the final exam.`)
                    
                    // Auto-hide success message after 3 seconds
                    setTimeout(() => {
                        this.hideError('test-mode-success')
                    }, 3000)
                    
                } catch (error) {
                    console.error('Failed to update test mode:', error)
                    
                    // Revert toggle state on error
                    this.elements.testModeToggle.checked = !isEnabled
                    this.elements.testModeStatus.textContent = !isEnabled ? 'Enabled' : 'Disabled'
                    this.elements.testModeStatus.style.color = !isEnabled ? '#166534' : '#dc2626'
                    
                    this.showError('test-mode-error', 'Failed to update final exam setting. Please try again.')
                    
                } finally {
                    // Re-enable toggle
                    this.elements.testModeToggle.disabled = false
                }
            }
            
            renderSubmissionsTable() {
                if (this.submissions.length === 0) {
                    this.elements.submissionsTableBody.innerHTML = ''
                    this.elements.noSubmissions.classList.remove('hidden')
                    document.getElementById('submissions-table-container').classList.add('hidden')
                    return
                }
                
                this.elements.noSubmissions.classList.add('hidden')
                document.getElementById('submissions-table-container').classList.remove('hidden')
                
                this.elements.submissionsTableBody.innerHTML = this.submissions.map(submission => {
                    const submittedDate = new Date(submission.submitted_at).toLocaleDateString()
                    const submittedTime = new Date(submission.submitted_at).toLocaleTimeString()
                    const percentage = Math.round((submission.total_score / submission.max_score) * 100)
                    
                    // Determine if manually graded (check if any final points differ from auto points)
                    const hasManualGrades = submission.questions.some(q => q.points_awarded !== q.auto_points)
                    const statusBadge = hasManualGrades 
                        ? '<span style="background: #fbbf24; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">‚úèÔ∏è Manually Graded</span>'
                        : '<span style="background: #e5e7eb; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">ü§ñ Auto-graded</span>'
                    
                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb; hover:background-color: #f9fafb;" class="hover:bg-gray-50">
                            <td style="padding: 1rem;">
                                <div style="font-weight: 600; color: #1f2937;">${submission.student_name}</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                    ID: ${submission.id.substring(0, 8)}...
                                </div>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <div style="font-weight: 600; color: #0369a1; font-size: 1.1rem;">
                                    ${submission.total_score}/${submission.max_score}
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    ${percentage}%
                                </div>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <div style="font-weight: 500;">${submission.questions.length}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">questions</div>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                ${statusBadge}
                            </td>
                            <td style="padding: 1rem; text-align: center; font-size: 0.875rem; color: #6b7280;">
                                <div>${submittedDate}</div>
                                <div>${submittedTime}</div>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <button class="button button-primary" onclick="teacherPortal.gradeSubmission('${submission.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    üìù Grade
                                </button>
                            </td>
                        </tr>
                    `
                }).join('')
            }
            
            gradeSubmission(submissionId) {
                const submission = this.submissions.find(s => s.id === submissionId)
                if (!submission) {
                    alert('Submission not found')
                    return
                }
                
                this.currentSubmission = submission
                this.pendingChanges.clear()
                this.renderGradingScreen(submission)
                this.showScreen('grading')
            }
            
            renderGradingScreen(submission) {
                const submittedDate = new Date(submission.submitted_at).toLocaleString()
                const timeTaken = Math.round((new Date(submission.end_time) - new Date(submission.start_time)) / 1000 / 60)
                
                this.elements.gradingTitle.textContent = `üìù Grading: ${submission.student_name}`
                this.elements.gradingSubtitle.textContent = `${submission.questions.length} questions ‚Ä¢ Submitted ${submittedDate}`
                
                const questionsHtml = submission.questions.map((question, index) => {
                    const userAnswer = this.formatAnswer(question.user_answer, question.question_type)
                    const correctAnswer = this.formatCorrectAnswer(question)
                    const isAutoGraded = question.question_type !== 'SHORT_ANSWER'
                    const hasChanged = question.points_awarded !== question.auto_points
                    
                    return `
                        <div class="question-review" style="${hasChanged ? 'border-left-color: #fbbf24;' : ''}">
                            <div class="question-text">
                                Q${index + 1}: ${question.question_text}
                                <span style="font-size: 0.875rem; color: #6b7280; font-weight: normal;">
                                    (${question.question_type.replace(/_/g, ' ')})
                                </span>
                                ${hasChanged ? '<span style="margin-left: 0.5rem; color: #d97706; font-size: 0.75rem;">‚úèÔ∏è Modified</span>' : ''}
                            </div>
                            
                            <div class="answer-display">
                                <strong>Student Answer:</strong><br>
                                ${userAnswer}
                            </div>
                            
                            ${isAutoGraded && correctAnswer ? `
                                <div class="answer-display" style="background: #f0fdf4; border-color: #bbf7d0;">
                                    <strong>Correct Answer:</strong><br>
                                    ${correctAnswer}
                                </div>
                            ` : ''}
                            
                            ${question.grading_notes ? `
                                <div style="background: #fef3c7; border: 1px solid #fcd34d; padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; font-size: 0.875rem;">
                                    <strong>Grading Notes:</strong> ${question.grading_notes}
                                </div>
                            ` : ''}
                            
                            <div class="points-section">
                                <span>Points:</span>
                                <input type="number" 
                                       class="points-input grading-points-input" 
                                       min="0" 
                                       max="${question.max_points}" 
                                       value="${question.points_awarded || 0}"
                                       data-question-id="${question.question_id}"
                                       data-auto-points="${question.auto_points}">
                                <span>/ ${question.max_points}</span>
                                <span style="margin-left: auto; font-size: 0.875rem; color: #6b7280;">
                                    Auto: ${question.auto_points} ‚Ä¢ ${isAutoGraded ? '(Auto-graded)' : '(Manual grading required)'}
                                </span>
                            </div>
                        </div>
                    `
                }).join('')
                
                this.elements.submissionDetails.innerHTML = `
                    <div class="submission-header" style="margin-bottom: 2rem;">
                        <div>
                            <div class="student-info">${submission.student_name}</div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                ${submission.questions.length} questions ‚Ä¢ Time: ${timeTaken} minutes
                            </div>
                        </div>
                        <div class="score-summary">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0369a1;" id="current-total-score">
                                    ${submission.total_score}/${submission.max_score}
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280;" id="current-percentage">
                                    ${Math.round((submission.total_score / submission.max_score) * 100)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${questionsHtml}
                `
                
                // Bind events for points inputs in grading screen
                this.bindGradingEvents()
            }
            
            bindGradingEvents() {
                const pointsInputs = document.querySelectorAll('.grading-points-input')
                pointsInputs.forEach(input => {
                    input.addEventListener('input', this.handlePointsChange.bind(this))
                })
            }
            
            handlePointsChange(e) {
                const input = e.target
                const questionId = input.dataset.questionId
                const newPoints = Math.max(0, Math.min(parseInt(input.value) || 0, parseInt(input.max)))
                const autoPoints = parseInt(input.dataset.autoPoints)
                
                // Ensure input value is within bounds
                input.value = newPoints
                
                // Track the change
                this.pendingChanges.set(questionId, newPoints)
                
                // Update visual indication if different from auto score
                const questionReview = input.closest('.question-review')
                if (newPoints !== autoPoints) {
                    questionReview.style.borderLeftColor = '#fbbf24'
                    input.style.backgroundColor = '#fef3c7'
                } else {
                    questionReview.style.borderLeftColor = '#0369a1'
                    input.style.backgroundColor = ''
                }
                
                // Update total score display
                this.updateTotalScoreDisplay()
                
                // Show save button as highlighted if there are pending changes
                if (this.pendingChanges.size > 0) {
                    this.elements.saveGradesBtn.style.backgroundColor = '#dc2626'
                    this.elements.saveGradesBtn.innerHTML = 'üíæ Save Changes (' + this.pendingChanges.size + ')'
                } else {
                    this.elements.saveGradesBtn.style.backgroundColor = '#0369a1'
                    this.elements.saveGradesBtn.innerHTML = 'üíæ Save All Changes'
                }
            }
            
            updateTotalScoreDisplay() {
                if (!this.currentSubmission) return
                
                let newTotal = 0
                this.currentSubmission.questions.forEach(question => {
                    const pendingPoints = this.pendingChanges.get(question.question_id)
                    newTotal += pendingPoints !== undefined ? pendingPoints : question.points_awarded
                })
                
                const maxScore = this.currentSubmission.max_score
                const percentage = Math.round((newTotal / maxScore) * 100)
                
                document.getElementById('current-total-score').textContent = `${newTotal}/${maxScore}`
                document.getElementById('current-percentage').textContent = `${percentage}%`
            }
            
            async handleSaveGrades() {
                if (this.pendingChanges.size === 0) {
                    this.showError('grading-error', 'No changes to save')
                    return
                }
                
                this.hideError('grading-error')
                this.hideError('grading-success')
                
                const originalText = this.elements.saveGradesBtn.innerHTML
                this.elements.saveGradesBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span>Saving...'
                this.elements.saveGradesBtn.disabled = true
                
                try {
                    // Save all pending changes
                    for (const [questionId, pointsAwarded] of this.pendingChanges) {
                        await fetch('/api/teacher/update-grade', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                submissionId: this.currentSubmission.id,
                                questionId,
                                pointsAwarded
                            })
                        })
                    }
                    
                    // Update local submission data
                    this.pendingChanges.forEach((points, questionId) => {
                        const question = this.currentSubmission.questions.find(q => q.question_id === questionId)
                        if (question) {
                            question.points_awarded = points
                        }
                    })
                    
                    // Recalculate total score
                    this.currentSubmission.total_score = this.currentSubmission.questions.reduce(
                        (sum, q) => sum + q.points_awarded, 0
                    )
                    
                    // Update the submission in the main list
                    const submissionIndex = this.submissions.findIndex(s => s.id === this.currentSubmission.id)
                    if (submissionIndex !== -1) {
                        this.submissions[submissionIndex] = { ...this.currentSubmission }
                    }
                    
                    this.pendingChanges.clear()
                    this.showError('grading-success', `Successfully saved ${this.pendingChanges.size || 'all'} grade changes!`)
                    
                    // Reset save button
                    this.elements.saveGradesBtn.style.backgroundColor = '#0369a1'
                    this.elements.saveGradesBtn.innerHTML = 'üíæ Save All Changes'
                    
                } catch (error) {
                    console.error('Failed to save grades:', error)
                    this.showError('grading-error', 'Failed to save grades. Please try again.')
                } finally {
                    this.elements.saveGradesBtn.disabled = false
                    this.elements.saveGradesBtn.innerHTML = originalText
                }
            }
            
            handleBackToDashboard() {
                if (this.pendingChanges.size > 0) {
                    const confirmLeave = confirm(`You have ${this.pendingChanges.size} unsaved changes. Are you sure you want to go back without saving?`)
                    if (!confirmLeave) return
                }
                
                this.pendingChanges.clear()
                this.currentSubmission = null
                this.showScreen('dashboard')
                this.loadSubmissions() // Refresh the table
            }
            
            formatAnswer(answer, questionType) {
                if (!answer) return '<em style="color: #6b7280;">(No answer provided)</em>'
                
                switch (questionType) {
                    case 'TRUE_FALSE':
                        return answer ? 'True' : 'False'
                    case 'SIMPLE_FILL_IN_THE_BLANK':
                        if (Array.isArray(answer)) {
                            return answer.map((ans, i) => `${i + 1}. ${ans || '<em>(empty)</em>'}`).join('<br>')
                        }
                        return answer
                    case 'STRUCTURED_FILL_IN_THE_BLANK':
                        if (Array.isArray(answer)) {
                            return answer.map((ans, i) => `Part ${i + 1}: ${ans || '<em>(empty)</em>'}`).join('<br>')
                        }
                        return answer
                    case 'SHORT_ANSWER':
                        return answer.replace(/\n/g, '<br>')
                    default:
                        return String(answer)
                }
            }
            
            formatCorrectAnswer(question) {
                switch (question.question_type) {
                    case 'TRUE_FALSE':
                        return question.correct_answer ? 'True' : 'False'
                    case 'SIMPLE_FILL_IN_THE_BLANK':
                        return question.correct_answers ? question.correct_answers.join(', ') : 'N/A'
                    case 'STRUCTURED_FILL_IN_THE_BLANK':
                        return question.parts ? question.parts.map((part, i) => 
                            `Part ${i + 1}: ${part.correct_answer}`
                        ).join('<br>') : 'N/A'
                    case 'SHORT_ANSWER':
                        return null // No "correct" answer to show for short answer
                    default:
                        return 'N/A'
                }
            }
        }
        
        // Initialize the teacher portal when page loads
        const teacherPortal = new TeacherPortal()
    </script>
    
    <!-- Footer -->
    <footer style="background-color: #f9fafb; border-top: 1px solid #e5e7eb; padding: 2rem 0; margin-top: 2rem;">
        <div style="max-width: 1200px; margin: 0 auto; text-align: center; padding: 0 2rem;">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                <img src="/public/Heartbeat_Brandmark_Horizontal_Black.svg" alt="Heartbeat Church" style="height: 2rem;">
            </div>
            <p style="font-size: 0.875rem; color: #6b7280;">
                ¬© Heartbeat Church 2025. Made with <span style="color: #dc2626;">‚ô•</span> by Digital Platform Team.
            </p>
        </div>
    </footer>
</body>
</html>
